{
  "name": "Phase B â€” Session Lifecycle & Task Governance",
  "branchName": "ralph/phase-b-session-lifecycle",
  "description": "Enhance HiveMind's context governance with stop-decision injection, session boundary management, task manifest persistence, and auto-commit integration",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Messages Transform Hook Core",
      "description": "As a HiveMind developer, I want to implement the experimental.chat.messages.transform hook so that I can inject stop-decision checklists before the LLM decides to stop.",
      "acceptanceCriteria": [
        "Create file src/hooks/messages-transform.ts with createMessagesTransformHook factory function",
        "Hook signature matches OpenCode SDK: (input: {}, output: { messages: MessageV2[] }) => Promise<void>",
        "Hook reads brain state and config to determine checklist items",
        "Checklist injection budget capped at 300 characters",
        "P3 error handling â€” never break message flow",
        "Create test file tests/hooks/messages-transform-001-[date]-[time].test.ts",
        "Integration test verifies synthetic message injection",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 1,
      "passes": false,
      "notes": "",
      "dependsOn": [],
      "files": [
        "src/hooks/messages-transform.ts",
        "tests/hooks/messages-transform-001-[date]-[time].test.ts"
      ]
    },
    {
      "id": "US-002",
      "title": "Implement Stop-Decision Checklist Injection",
      "description": "As an AI agent using HiveMind, I want a checklist injected before I stop so that I verify all required work is complete.",
      "acceptanceCriteria": [
        "Checklist items dynamically generated from brain state: Hierarchy cursor check (action level missing?)",
        "map_context called this session?",
        "Subagent failure acknowledgment (pending_failure_ack)",
        "Git commit needed for file changes",
        "Injected as synthetic <system-reminder> part with synthetic: true flag",
        "Checklist format: <system-reminder>\nCHECKLIST BEFORE STOPPING:\n- [ ] item\n...\n</system-reminder>",
        "Skipped if governance_mode === 'permissive'",
        "Test verifies checklist appears in messages array when conditions met",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 2,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-001"],
      "files": [
        "src/hooks/messages-transform.ts"
      ]
    },
    {
      "id": "US-003",
      "title": "Implement User Message Continuity Transformation",
      "description": "As an AI agent continuing work, I want my user messages augmented with anchor context so that I maintain continuity across turns.",
      "acceptanceCriteria": [
        "Find latest non-synthetic user message in messages array",
        "Load anchors from .hivemind/state/anchors.json",
        "Load hierarchy cursor path from tree",
        "Prepend <anchor-context> block with top 3 anchors",
        "Prepend <focus> element with cursor ancestry path",
        "Prepend as synthetic part (doesn't modify user's actual text)",
        "Budget capped at 200 characters for anchor context",
        "Test verifies user message augmented when anchors exist",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 3,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-002"],
      "files": [
        "src/hooks/messages-transform.ts",
        "tests/hooks/messages-transform-001-[date]-[time].test.ts"
      ]
    },
    {
      "id": "US-003-A",
      "title": "Register Messages Transform Hook in Plugin",
      "description": "As a HiveMind user, I want the messages-transform hook registered so that it activates on every LLM call.",
      "acceptanceCriteria": [
        "Import createMessagesTransformHook in src/index.ts",
        "Add to hooks object: 'experimental.chat.messages.transform': createMessagesTransformHook(log, effectiveDir)",
        "Run npm test â€” all existing tests still pass",
        "Run npm run typecheck â€” no errors",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 4,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-003"],
      "files": [
        "src/index.ts"
      ]
    },
    {
      "id": "US-004",
      "title": "Handle todo.updated Event",
      "description": "As a HiveMind user, I want my TODOs persisted to tasks.json so that they survive across sessions.",
      "acceptanceCriteria": [
        "Add case 'todo.updated': to src/hooks/event-handler.ts",
        "Extract sessionID and todos array from event properties",
        "Load current brain state to get session context",
        "Write to .hivemind/state/tasks.json with structure: { session_id, updated_at, tasks[] }",
        "Create test file tests/hooks/event-handler-todo-[date]-[time].test.ts",
        "Test verifies tasks.json created with correct content",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 1,
      "passes": false,
      "notes": "",
      "dependsOn": [],
      "files": [
        "src/hooks/event-handler.ts",
        "tests/hooks/event-handler-todo-[date]-[time].test.ts"
      ]
    },
    {
      "id": "US-005",
      "title": "Create Task Manifest Schema and Helpers",
      "description": "As a HiveMind developer, I want a typed schema for tasks.json so that I have type safety when working with task data.",
      "acceptanceCriteria": [
        "Add TaskManifest interface to src/schemas/manifest.ts (or create if needed)",
        "Interface includes: session_id, updated_at, tasks[] with TaskItem type",
        "Add loadTasks(directory) helper in src/lib/manifest.ts or new file",
        "Add saveTasks(directory, manifest) helper",
        "Ensure .hivemind/state/tasks.json path uses getEffectivePaths()",
        "Unit tests for load/save helpers",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 2,
      "passes": false,
      "notes": "",
      "dependsOn": [],
      "files": [
        "src/schemas/manifest.ts",
        "src/lib/manifest.ts",
        "tests/lib/manifest-tasks-[date]-[time].test.ts"
      ]
    },
    {
      "id": "US-006",
      "title": "Create Auto-Commit Logic Module",
      "description": "As a HiveMind developer, I want a dedicated module for auto-commit logic so that it's testable and reusable.",
      "acceptanceCriteria": [
        "Create src/lib/auto-commit.ts",
        "Export shouldAutoCommit(tool: string): boolean â€” returns true for write, edit, bash",
        "Export generateCommitMessage(ctx: AutoCommitContext): string â€” conventional format",
        "Export executeAutoCommit(ctx: AutoCommitContext): Promise<{ success, message }>",
        "Use Bun's $ for git commands: git add, git commit",
        "Create test file tests/lib/auto-commit-[date]-[time].test.ts",
        "Tests for shouldAutoCommit, generateCommitMessage",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 1,
      "passes": false,
      "notes": "",
      "dependsOn": [],
      "files": [
        "src/lib/auto-commit.ts",
        "tests/lib/auto-commit-[date]-[time].test.ts"
      ]
    },
    {
      "id": "US-007",
      "title": "Integrate Auto-Commit into tool.execute.after Hook",
      "description": "As a HiveMind user, I want file changes automatically committed so that I have an audit trail of modifications.",
      "acceptanceCriteria": [
        "Import auto-commit functions in src/hooks/soft-governance.ts",
        "Check config.auto_commit flag (add to config schema if needed)",
        "After detection tracking, call executeAutoCommit if conditions met: shouldAutoCommit(toolName) returns true and Files were modified (extract from output.metadata or state)",
        "Log success/failure at debug level",
        "Don't block execution on commit failure â€” just log",
        "Integration test verifies commit triggered on file write",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 2,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-006"],
      "files": [
        "src/hooks/soft-governance.ts",
        "src/schemas/config.ts",
        "tests/hooks/soft-governance-[date]-[time].test.ts"
      ]
    },
    {
      "id": "US-008",
      "title": "Create Session Boundary Manager Module",
      "description": "As a HiveMind developer, I want logic to determine when to create a new session so that context doesn't become poisoned.",
      "acceptanceCriteria": [
        "Create src/lib/session-boundary.ts",
        "Export SessionBoundaryState interface with turnCount, contextPercent, hierarchyComplete, isMainSession, hasDelegations",
        "Export shouldCreateNewSession(state): SessionBoundaryRecommendation",
        "Rules implemented: Only main session (delegation excluded), Context must be <80%, Natural boundaries: completed phase/epic, turn threshold (30+)",
        "Export estimateContextPercent(turnCount, compactThreshold): number",
        "Create test file tests/lib/session-boundary-[date]-[time].test.ts",
        "Tests for each rule",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 1,
      "passes": false,
      "notes": "",
      "dependsOn": [],
      "files": [
        "src/lib/session-boundary.ts",
        "tests/lib/session-boundary-[date]-[time].test.ts"
      ]
    },
    {
      "id": "US-009",
      "title": "Integrate Boundary Detection into Session Lifecycle",
      "description": "As a HiveMind user, I want to see recommendations for creating fresh sessions when appropriate.",
      "acceptanceCriteria": [
        "Import session-boundary functions in src/hooks/session-lifecycle.ts",
        "Call estimateContextPercent with turn count and auto_compact_on_turns",
        "Call shouldCreateNewSession with current state",
        "If recommended, add to warningLines: ðŸ”„ [reason] and â†’ Run /hivemind-compact to archive and start fresh",
        "Integration test verifies warning appears when conditions met",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 2,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-008"],
      "files": [
        "src/hooks/session-lifecycle.ts",
        "tests/hooks/session-lifecycle-[date]-[time].test.ts"
      ]
    },
    {
      "id": "US-010",
      "title": "Inject Boundary Recommendation via Messages Transform",
      "description": "As an AI agent, I want session boundary recommendations injected before I stop so I can decide whether to compact.",
      "acceptanceCriteria": [
        "In src/hooks/messages-transform.ts, load session-boundary module",
        "If shouldCreateNewSession returns recommended: true, add to checklist: - [ ] Session boundary reached: [reason]",
        "Include in stop-decision checklist injection",
        "Test verifies boundary item appears in checklist when threshold met",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 3,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-003-A", "US-009"],
      "files": [
        "src/hooks/messages-transform.ts",
        "tests/hooks/messages-transform-001-[date]-[time].test.ts"
      ]
    },
    {
      "id": "US-011",
      "title": "Create New SDK Session after Compact",
      "description": "As a HiveMind user, I want a new OpenCode session created automatically after compacting so that I get a clean context.",
      "acceptanceCriteria": [
        "In src/tools/compact-session.ts, after successful archival:",
        "Get SDK client via getClient() from src/hooks/sdk-context.ts",
        "Call client.session.create() with: directory (current project directory), title: HiveMind: ${newSessionId}, parentID: previous session ID (for navigation)",
        "Log new session ID at info level",
        "Non-fatal if session creation fails (archival already succeeded)",
        "Integration test verifies new session created",
        "npm test passes",
        "npm run typecheck passes",
        "Run requesting-code-review skill for peer review"
      ],
      "priority": 4,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-009"],
      "files": [
        "src/tools/compact-session.ts"
      ]
    }
  ]
}
