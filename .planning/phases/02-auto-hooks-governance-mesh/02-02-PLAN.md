---
phase: 02-auto-hooks-governance-mesh
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/event-handler.ts
  - src/hooks/soft-governance.ts
  - src/hooks/compaction.ts
  - tests/soft-governance.test.ts
  - tests/sdk-foundation.test.ts
  - tests/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Users receive toast feedback for drift/evidence alerts and compaction events"
    - "Session staleness checks are triggered by session.idle event handling instead of turn-count approximation"
    - "Governance feedback remains soft (warnings/toasts only, no hard blocking)"
  artifacts:
    - path: "src/hooks/event-handler.ts"
      provides: "session.idle-driven stale check pipeline"
      contains: "session.idle"
    - path: "src/hooks/soft-governance.ts"
      provides: "Drift/evidence toast trigger integration"
      contains: "showToast"
    - path: "src/hooks/compaction.ts"
      provides: "Compaction toast notification"
      contains: "showToast"
  key_links:
    - from: "src/hooks/event-handler.ts"
      to: "src/lib/staleness.ts"
      via: "event-driven stale evaluation"
      pattern: "isSessionStale"
    - from: "src/hooks/soft-governance.ts"
      to: "SDK client tui"
      via: "withClient wrapper for toast side effects"
      pattern: "withClient"
---

<objective>
Implement event-driven governance feedback by wiring idle-time stale checks and visual toast alerts for drift, evidence pressure, and compaction.

Purpose: Deliver GOV-04 and GOV-05 with SDK-safe hook adapters while preserving soft-governance constraints.

Output: Event handler staleness actions, toast-enabled governance hooks, and tests covering event + visual feedback behavior.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-auto-hooks-governance-mesh/02-RESEARCH.md
@.planning/phases/01-sdk-foundation-system-core/01-02-SUMMARY.md

@src/hooks/event-handler.ts
@src/hooks/soft-governance.ts
@src/hooks/compaction.ts
@src/hooks/sdk-context.ts
@src/lib/staleness.ts
@tests/soft-governance.test.ts
@tests/sdk-foundation.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire session.idle to staleness evaluation in event hook</name>
  <files>src/hooks/event-handler.ts, tests/sdk-foundation.test.ts, tests/integration.test.ts</files>
  <action>Replace the current session.idle log-only stub with real stale check behavior. On `session.idle`, load state/config, compute stale info using `isSessionStale`/`getStalenessInfo`, and emit warning + toast reminder when stale threshold is exceeded. Keep non-fatal behavior with try/catch and avoid any hard-blocking paths. Maintain existing event logging for observability.</action>
  <verify>Run `npx tsx --test tests/sdk-foundation.test.ts` and `npx tsx --test tests/integration.test.ts` to confirm idle-event behavior is exercised.</verify>
  <done>`session.idle` now drives stale-session governance checks with warning/toast side effects, not only logging.</done>
</task>

<task type="auto">
  <name>Task 2: Add toast feedback channel for drift/evidence/compaction signals</name>
  <files>src/hooks/soft-governance.ts, src/hooks/compaction.ts, tests/soft-governance.test.ts, tests/integration.test.ts</files>
  <action>Integrate `client.tui.showToast()` via `withClient` in hook layer only (no SDK imports in `src/lib`). Trigger toasts for drift/evidence escalation in soft-governance and for compaction completion in compaction hook. Add dedupe/cooldown logic to prevent repeated identical toast spam during rapid tool calls. Preserve graceful fallback when SDK client is unavailable.</action>
  <verify>Run `npx tsx --test tests/soft-governance.test.ts` and `npx tsx --test tests/integration.test.ts`.</verify>
  <done>Visual governance feedback appears for drift, evidence pressure, and compaction; repeated duplicate alerts are throttled and plugin remains stable without SDK client.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx tsx --test tests/sdk-foundation.test.ts` passes
3. `npx tsx --test tests/soft-governance.test.ts` passes
4. `npx tsx --test tests/integration.test.ts` passes with event/toast assertions
</verification>

<success_criteria>
- GOV-04 satisfied: showToast channel active for governance warnings and compaction notices
- GOV-05 satisfied: session.idle event drives Time-to-Stale checks
- Soft-governance policy preserved: no deny/block behavior introduced
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-hooks-governance-mesh/02-02-SUMMARY.md`
</output>
