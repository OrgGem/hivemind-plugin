---
phase: 02-auto-hooks-governance-mesh
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/hooks/event-handler.ts
  - src/hooks/soft-governance.ts
  - src/hooks/compaction.ts
  - src/hooks/sdk-context.ts
  - tests/soft-governance.test.ts
  - tests/sdk-foundation.test.ts
  - tests/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Users receive dual-channel governance feedback: toasts for humans and corrective prompt messaging for agents"
    - "Session staleness and drift/evidence signals emit toasts with the locked severity mapping"
    - "Compaction notices remain informational and do not escalate"
  artifacts:
    - path: "src/hooks/event-handler.ts"
      provides: "session.idle-driven stale signal emission"
      contains: "session.idle"
    - path: "src/hooks/soft-governance.ts"
      provides: "Governance signal-to-toast adapter with severity escalation"
      contains: "showToast"
    - path: "src/hooks/compaction.ts"
      provides: "Info-only compaction toast handling"
      contains: "variant: \"info\""
  key_links:
    - from: "src/hooks/event-handler.ts"
      to: "src/lib/staleness.ts"
      via: "idle-event stale evaluation"
      pattern: "getStalenessInfo"
    - from: "src/hooks/soft-governance.ts"
      to: "src/hooks/sdk-context.ts"
      via: "SDK-safe showToast dispatch"
      pattern: "getClient"
---

<objective>
Implement the dual-channel adapter layer so governance signals become human-visible toasts and stay aligned with agent corrective messaging.

Purpose: Deliver GOV-04 and GOV-05 while honoring locked toast personality, severity escalation, and hybrid language decisions.

Output: Event and governance hook updates that emit showToast feedback with dedupe/cooldown and SDK fallback-safe behavior.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-auto-hooks-governance-mesh/02-RESEARCH.md
@.planning/phases/01-sdk-foundation-system-core/01-02-SUMMARY.md

@src/hooks/event-handler.ts
@src/hooks/soft-governance.ts
@src/hooks/compaction.ts
@src/hooks/sdk-context.ts
@src/lib/staleness.ts
@tests/soft-governance.test.ts
@tests/sdk-foundation.test.ts
@tests/integration.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire event-driven stale governance and human-visible toasts</name>
  <files>src/hooks/event-handler.ts, tests/sdk-foundation.test.ts, tests/integration.test.ts</files>
  <action>Replace `session.idle` and related event stubs with real governance signal routing. On idle events, evaluate staleness via `getStalenessInfo`, emit drift/stale signals, and dispatch toast variants using locked mapping (`warning` then `error` on repeat). Keep compaction event notices strictly `info`. Maintain graceful fallback when SDK client is missing and keep event handling non-fatal.</action>
  <verify>Run `npx tsx --test tests/sdk-foundation.test.ts` and `npx tsx --test tests/integration.test.ts` to confirm idle-event behavior is exercised.</verify>
  <done>`session.idle` drives stale governance checks with aligned toast behavior, and compaction events produce informational notices only.</done>
</task>

<task type="auto">
  <name>Task 2: Add toast adapter discipline (hybrid language, dedupe, and severity escalation)</name>
  <files>src/hooks/soft-governance.ts, src/hooks/compaction.ts, tests/soft-governance.test.ts, tests/integration.test.ts</files>
  <action>Implement shared toast emission discipline in hooks only: tool names stay English, surrounding guidance text follows configured language. Enforce severity progression for out-of-order tool use and evidence pressure (`info/warning/error` and `warning/error` respectively), and keep IGNORED toast as `error` triage format (`reason + current phase/action + suggested fix command`). Add dedupe/cooldown to prevent spam and preserve fallback-safe behavior without SDK.</action>
  <verify>Run `npx tsx --test tests/soft-governance.test.ts` and `npx tsx --test tests/integration.test.ts`.</verify>
  <done>Dual-channel governance feedback is consistent, toast language/severity match locked decisions, duplicates are throttled, and no hard-block behavior is introduced.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx tsx --test tests/sdk-foundation.test.ts` passes
3. `npx tsx --test tests/soft-governance.test.ts` passes
4. `npx tsx --test tests/integration.test.ts` passes with event + toast severity assertions
</verification>

<success_criteria>
- GOV-04 satisfied: showToast channel active for governance warnings and compaction notices with locked mapping
- GOV-05 satisfied: session.idle event drives Time-to-Stale checks
- Locked decision fidelity: hybrid toast language and IGNORED triage format are implemented
- Soft-governance policy preserved: no hard deny/block behavior introduced
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-hooks-governance-mesh/02-02-SUMMARY.md`
</output>
