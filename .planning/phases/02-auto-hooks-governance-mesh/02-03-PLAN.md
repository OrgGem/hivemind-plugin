---
phase: 02-auto-hooks-governance-mesh
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/framework-context.ts
  - src/lib/index.ts
  - src/hooks/session-lifecycle.ts
  - tests/framework-context.test.ts
  - tests/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "GSD and Spec-kit repositories are detected from marker paths without expensive full-tree scans"
    - "When a GSD phase goal exists, system prompt includes that goal and drift guidance references it"
    - "Framework-aware behavior works in gsd-only, spec-kit-only, both, and no-framework project layouts"
  artifacts:
    - path: "src/lib/framework-context.ts"
      provides: "Pure framework detection + GSD phase-goal extraction helpers"
      exports: ["detectFrameworkContext", "extractCurrentGsdPhaseGoal"]
    - path: "src/hooks/session-lifecycle.ts"
      provides: "Framework-aware prompt enrichment and drift hints"
      contains: "Framework:"
    - path: "tests/framework-context.test.ts"
      provides: "Deterministic framework detection coverage"
      min_lines: 80
  key_links:
    - from: "src/hooks/session-lifecycle.ts"
      to: "src/lib/framework-context.ts"
      via: "detect framework + phase goal before warning assembly"
      pattern: "detectFrameworkContext"
    - from: "src/lib/framework-context.ts"
      to: ".planning/ROADMAP.md"
      via: "extract phase goal for current phase"
      pattern: "Phase"
---

<objective>
Add framework-awareness so governance prompt and drift guidance adapt to detected project context, especially active GSD phase goals.

Purpose: Deliver GOV-06 and GOV-07 while preserving strict architecture boundaries (`src/lib` pure, hooks as SDK adapters).

Output: Pure framework-detection helpers plus session lifecycle integration and tests for framework matrix behavior.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-auto-hooks-governance-mesh/02-RESEARCH.md

@src/hooks/session-lifecycle.ts
@src/lib/index.ts
@tests/integration.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build pure framework context detector with GSD phase-goal extraction</name>
  <files>src/lib/framework-context.ts, src/lib/index.ts</files>
  <action>Create `framework-context` pure helpers that detect framework markers (`.planning/`, `.spec-kit/`) and classify context (`gsd`, `spec-kit`, `both`, `none`). Add lightweight GSD parser that reads current phase goal from `.planning/ROADMAP.md` using deterministic pattern matching (no SDK dependencies, no full-tree scans). Export helpers through `src/lib/index.ts`.</action>
  <verify>Run `npx tsc --noEmit` and `npx tsx --test tests/framework-context.test.ts`.</verify>
  <done>Pure helpers return stable framework classification and optional current GSD phase goal for use by hooks.</done>
</task>

<task type="auto">
  <name>Task 2: Inject framework-aware guidance and phase-goal drift hints into system prompt</name>
  <files>src/hooks/session-lifecycle.ts, tests/framework-context.test.ts, tests/integration.test.ts</files>
  <action>Integrate framework detection into session lifecycle warning assembly. When GSD context is present and phase goal is available, include goal-aware guidance line and bias drift messaging toward phase-goal alignment plus hierarchy state. Add matrix tests for gsd-only, spec-kit-only, both-framework, and no-framework repositories. Keep behavior additive and budget-aware.</action>
  <verify>Run `npx tsx --test tests/framework-context.test.ts` and `npx tsx --test tests/integration.test.ts`.</verify>
  <done>System prompt consistently reflects detected framework context, and GSD phase goals are surfaced for drift alignment when available.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx tsx --test tests/framework-context.test.ts` passes for all framework combinations
3. `npx tsx --test tests/integration.test.ts` passes with framework-aware prompt assertions
</verification>

<success_criteria>
- GOV-06 satisfied: framework detector identifies GSD and Spec-kit markers
- GOV-07 satisfied: GSD phase goal is injected and used for drift guidance when available
- Boundary preserved: new framework logic remains in `src/lib` without SDK imports
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-hooks-governance-mesh/02-03-SUMMARY.md`
</output>
