---
phase: 02-auto-hooks-governance-mesh
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/framework-context.ts
  - src/lib/index.ts
  - src/hooks/session-lifecycle.ts
  - src/hooks/tool-gate.ts
  - src/schemas/brain-state.ts
  - tests/framework-context.test.ts
  - tests/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "When both GSD and Spec-kit are present, agent requests framework selection before implementation"
    - "GSD mode pins active phase goal at top of injected context"
    - "Conflict handling changes by governance setting: warn-only, limited mode, or simulated pause"
  artifacts:
    - path: "src/lib/framework-context.ts"
      provides: "Framework detection, selection menu model, and metadata contract validation"
      exports: ["detectFrameworkContext", "buildFrameworkSelectionMenu", "extractCurrentGsdPhaseGoal"]
    - path: "src/hooks/session-lifecycle.ts"
      provides: "Framework-aware drift messaging and conflict-gate prompt injection"
      contains: "Use GSD"
    - path: "src/hooks/tool-gate.ts"
      provides: "Limited-mode and simulated-pause gating behavior for framework conflicts"
      contains: "read/search/planning only"
    - path: "tests/framework-context.test.ts"
      provides: "Framework conflict and metadata-path validation coverage"
      min_lines: 120
  key_links:
    - from: "src/hooks/session-lifecycle.ts"
      to: "src/lib/framework-context.ts"
      via: "framework conflict resolution and goal pinning"
      pattern: "buildFrameworkSelectionMenu"
    - from: "src/lib/framework-context.ts"
      to: ".planning/ROADMAP.md"
      via: "extract active phase goal for GSD context"
      pattern: "Goal:"
---

<objective>
Add framework-conflict governance routing that forces explicit framework choice before implementation and keeps drift guidance framework-aware.

Purpose: Deliver GOV-06 and GOV-07 and honor locked framework-selection workflow, including metadata requirements and settings-driven responses.

Output: Pure framework context helpers plus hook-level gating that enforces selection menu paths and GSD phase-goal pinning.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-auto-hooks-governance-mesh/02-RESEARCH.md

@src/hooks/session-lifecycle.ts
@src/hooks/tool-gate.ts
@src/lib/index.ts
@src/schemas/brain-state.ts
@tests/integration.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build pure framework conflict detector and locked selection menu contract</name>
  <files>src/lib/framework-context.ts, src/lib/index.ts</files>
  <action>Create pure `framework-context` helpers that detect `.planning/` and `.spec-kit/`, classify context (`gsd`, `spec-kit`, `both`, `none`), parse current GSD phase goal, and build the locked selection menu options exactly: `Use GSD` (`active_phase`), `Use Spec-kit` (`active_spec_path`), `Proceed with override this session` (`acceptance_note`), `Cancel current task` (no metadata). Keep it deterministic and SDK-free.</action>
  <verify>Run `npx tsc --noEmit` and `npx tsx --test tests/framework-context.test.ts`.</verify>
  <done>Framework helper layer returns stable detection + selection contracts and extracts active GSD phase goal when present.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce settings-driven conflict handling and phase-goal-aware drift guidance</name>
  <files>src/hooks/session-lifecycle.ts, src/hooks/tool-gate.ts, src/schemas/brain-state.ts, tests/framework-context.test.ts, tests/integration.test.ts</files>
  <action>Integrate framework helpers into lifecycle/tool-gate paths. If both frameworks are detected, force pre-implementation framework selection and request consolidation first. If user explicitly accepts no-cleanup path, record acceptance note and still require framework selection before implementation. Implement settings-driven response tiers: default warn-only, higher governance limited mode (`read/search/planning only`), highest governance simulated pause until selection. In GSD mode, pin active phase goal at top of injected context and bias drift guidance to phase-goal + hierarchy alignment.</action>
  <verify>Run `npx tsx --test tests/framework-context.test.ts` and `npx tsx --test tests/integration.test.ts`.</verify>
  <done>Framework conflicts cannot proceed to implementation without explicit selection metadata, and GSD phase-goal pinning appears in system prompt when applicable.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx tsx --test tests/framework-context.test.ts` passes for all framework combinations and menu metadata paths
3. `npx tsx --test tests/integration.test.ts` passes with framework-aware prompt assertions
</verification>

<success_criteria>
- GOV-06 satisfied: framework detector identifies GSD and Spec-kit markers
- GOV-07 satisfied: GSD phase goal is pinned and used for drift guidance when available
- Locked decision fidelity: dual-framework flow enforces framework selection menu and metadata requirements before implementation
- Conflict response matches governance settings (warn-only, limited mode, simulated pause)
- Boundary preserved: new framework logic remains in `src/lib` without SDK imports
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-hooks-governance-mesh/02-03-SUMMARY.md`
</output>
