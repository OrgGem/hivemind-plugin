#!/usr/bin/env node
/**
 * hm-hop — Relation-based hop read from manifests.
 *
 * Usage: hm-hop <relation-type> [--from <id>] [--json]
 *
 * Relation types:
 *   - session: Hop from session to related entities
 *   - task: Hop from task to related entities
 *   - artifact: Hop from artifact to related entities
 *
 * Exit codes:
 *   0 - Success
 *   1 - Error (not found, invalid state, etc.)
 */

import { existsSync, readFileSync } from "node:fs"
import { dirname, join } from "node:path"

const HIVEMIND_DIR = ".hivemind"

function findProjectRoot() {
  let dir = process.cwd()
  while (dir !== "/") {
    if (existsSync(join(dir, HIVEMIND_DIR))) {
      return dir
    }
    dir = dirname(dir)
  }
  return null
}

function loadJson(filePath) {
  try {
    return JSON.parse(readFileSync(filePath, "utf-8"))
  } catch {
    return null
  }
}

function hopSession(projectRoot, fromId, jsonOutput) {
  const manifestPath = join(projectRoot, HIVEMIND_DIR, "sessions", "manifest.json")
  const manifest = loadJson(manifestPath)

  if (!manifest) {
    return { error: "No manifest found", code: 1 }
  }

  // If no fromId, use active session
  const targetStamp = fromId || manifest.active_stamp
  if (!targetStamp) {
    return { error: "No active session and no --from specified", code: 1 }
  }

  const session = manifest.sessions?.[targetStamp]
  if (!session) {
    return { error: `Session ${targetStamp} not found`, code: 1 }
  }

  // Load session file for more details
  const sessionPath = join(projectRoot, HIVEMIND_DIR, "sessions", "active", session.file || `${targetStamp}.md`)
  let sessionContent = null
  if (existsSync(sessionPath)) {
    try {
      const content = readFileSync(sessionPath, "utf-8")
      sessionContent = {
        file: session.file || `${targetStamp}.md`,
        size: content.length,
        hasPlan: content.includes("## Plan"),
      }
    } catch {
      // Ignore read errors
    }
  }

  const result = {
    stamp: targetStamp,
    session: {
      created: session.created,
      mode: session.mode,
      trajectory: session.trajectory,
      file: session.file,
    },
    content: sessionContent,
  }

  if (jsonOutput) {
    return { data: result, code: 0 }
  }

  let output = `Session: ${targetStamp}
  Created: ${new Date(session.created).toISOString()}
  Mode: ${session.mode}
  Trajectory: ${session.trajectory}`
  if (sessionContent) {
    output += `
  File: ${sessionContent.file} (${sessionContent.size} bytes)
  Has Plan: ${sessionContent.hasPlan}`
  }
  return { data: output, code: 0 }
}

function hopTask(projectRoot, fromId, jsonOutput) {
  const hierarchyPath = join(projectRoot, HIVEMIND_DIR, "hierarchy.json")
  const hierarchy = loadJson(hierarchyPath)

  if (!hierarchy || !hierarchy.root) {
    return { error: "No hierarchy tree found", code: 1 }
  }

  // Find all action-level nodes (tasks)
  const tasks = []
  function collectTasks(node, path = []) {
    if (node.level === "action") {
      tasks.push({
        id: node.id,
        content: node.content,
        status: node.status,
        stamp: node.stamp,
        path: [...path, node.content].join(" → "),
      })
    }
    for (const child of node.children || []) {
      collectTasks(child, [...path, node.content])
    }
  }
  collectTasks(hierarchy.root)

  if (fromId) {
    const task = tasks.find(t => t.id === fromId || t.stamp === fromId)
    if (!task) {
      return { error: `Task ${fromId} not found`, code: 1 }
    }
    if (jsonOutput) {
      return { data: task, code: 0 }
    }
    return {
      data: `Task: ${task.content}
  ID: ${task.id}
  Status: ${task.status}
  Path: ${task.path}`,
      code: 0,
    }
  }

  // Return all tasks
  if (jsonOutput) {
    return { data: { total: tasks.length, tasks }, code: 0 }
  }

  let output = `Tasks (${tasks.length} total):\n`
  for (const task of tasks.slice(0, 10)) {
    output += `  [${task.status}] ${task.content}\n`
  }
  if (tasks.length > 10) {
    output += `  ... and ${tasks.length - 10} more\n`
  }
  return { data: output, code: 0 }
}

function hopArtifact(projectRoot, fromId, jsonOutput) {
  const memsPath = join(projectRoot, HIVEMIND_DIR, "mems.json")
  const mems = loadJson(memsPath)

  if (!mems || !mems.mems) {
    return { error: "No mems found", code: 1 }
  }

  // Filter for artifacts (cycle-intel shelf)
  const artifacts = mems.mems.filter(m => m.shelf === "cycle-intel")

  if (fromId) {
    const artifact = artifacts.find(a => a.id === fromId)
    if (!artifact) {
      return { error: `Artifact ${fromId} not found`, code: 1 }
    }
    if (jsonOutput) {
      return { data: artifact, code: 0 }
    }
    return {
      data: `Artifact: ${artifact.id}
  Shelf: ${artifact.shelf}
  Created: ${new Date(artifact.created_at).toISOString()}
  Content: ${artifact.content.slice(0, 200)}${artifact.content.length > 200 ? "..." : ""}`,
      code: 0,
    }
  }

  // Return all artifacts
  if (jsonOutput) {
    return { data: { total: artifacts.length, artifacts }, code: 0 }
  }

  let output = `Artifacts (${artifacts.length} total):\n`
  for (const a of artifacts.slice(0, 10)) {
    const date = new Date(a.created_at).toISOString().split("T")[0]
    output += `  [${date}] ${a.content.slice(0, 60)}${a.content.length > 60 ? "..." : ""}\n`
  }
  if (artifacts.length > 10) {
    output += `  ... and ${artifacts.length - 10} more\n`
  }
  return { data: output, code: 0 }
}

function main() {
  const args = process.argv.slice(2)
  let relationType = null
  let fromId = null
  let jsonOutput = false

  for (let i = 0; i < args.length; i++) {
    const arg = args[i]
    if (arg === "--json") {
      jsonOutput = true
    } else if (arg === "--from") {
      fromId = args[++i]
    } else if (arg === "--help" || arg === "-h") {
      console.log(`hm-hop — Relation-based hop read from manifests

Usage: hm-hop <relation-type> [--from <id>] [--json]

Relation types:
  session   - Hop from session to related entities
  task      - Hop from task (action) to related entities
  artifact  - Hop from artifact (cycle-intel) to related entities

Options:
  --from <id>  - Start from specific ID (default: active/current)
  --json       - Output as JSON
  --help       - Show this help`)
      process.exit(0)
    } else if (!arg.startsWith("--")) {
      relationType = arg
    }
  }

  if (!relationType) {
    console.error("ERROR: No relation type specified. Use: session, task, or artifact")
    process.exit(1)
  }

  const projectRoot = findProjectRoot()
  if (!projectRoot) {
    console.error("ERROR: No .hivemind directory found. Run from a HiveMind project.")
    process.exit(1)
  }

  let result
  switch (relationType) {
    case "session":
      result = hopSession(projectRoot, fromId, jsonOutput)
      break
    case "task":
      result = hopTask(projectRoot, fromId, jsonOutput)
      break
    case "artifact":
      result = hopArtifact(projectRoot, fromId, jsonOutput)
      break
    default:
      console.error(`ERROR: Unknown relation type: ${relationType}`)
      process.exit(1)
  }

  if (result.error) {
    if (jsonOutput) {
      console.log(JSON.stringify({ error: result.error, success: false }))
    } else {
      console.error(`ERROR: ${result.error}`)
    }
    process.exit(result.code)
  }

  if (jsonOutput) {
    console.log(JSON.stringify({ success: true, data: result.data, timestamp: new Date().toISOString() }, null, 2))
  } else {
    console.log(result.data)
  }
  process.exit(0)
}

main()
